<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>
        <script type="text/javascript"  src="babylon.custom.js"></script>
        <script type="text/javascript"  src="babylon.gui.js"></script>
        <script  type="text/javascript" src="lib/babylon.skyMaterial.min.js"></script>
        <script  type="text/javascript" src="lib/babylon.gui.min.js"></script>
        <script type="text/javascript"  src="lib/pep.min.js"></script>
        <script type="text/javascript"  src="lib/dat.gui.min.js"></script>
        <script type="text/javascript"  src="lib/cannon.js"></script>
        <script type="text/javascript"  src="lib/Oimo.js"></script>
        <script type="text/javascript"  src="lib/earcut.min.js"></script>
        <script type="text/javascript"  src="lib/babylon.js"></script>
        <script type="text/javascript"  src="lib/babylon.inspector.bundle.js"></script>
        <script type="text/javascript"  src="lib/babylonjs.materials.min.js"></script>
        <script type="text/javascript"  src="lib/babylonjs.proceduralTextures.min.js"></script>
        <script type="text/javascript"  src="lib/babylonjs.postProcess.min.js"></script>
        <script type="text/javascript"  src="lib/babylonjs.loaders.js"></script>
        <script type="text/javascript"  src="lib/babylonjs.serializers.min.js"></script>
        <script type="text/javascript"  src="lib/babylon.gui.min.js"></script>
        <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.5.0"></script>
        <script type="text/javascript" src="js-toast-master/toast.min.js"></script>
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="lib/materialize.min.css">

        <!-- Compiled and minified JavaScript -->
        <script src="lib/materialize.min.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            #line{
                width: 150px;
                margin: 20px 0;
                height: 75px;
                background: #eee;
                position: absolute;
                top: 0px;
            }

            #graph1{
                position: absolute;
                top: 0px;
                
            }
            svg{
                background: ghostwhite;
                opacity: 0.5;
            }
             path {
            /*stroke: steelblue;*/
            stroke-width: 1;
            fill: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="graph1" class="aGraph" style="width:400px; height:150px;"></div>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.5.0"></script>
    <script>
        var canvas = document.getElementById("renderCanvas");
       // var engine = new BABYLON.Engine(canvas, true);
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
        engine.displayLoadingUI();
  var camera;
   var shadowGenerator;
   var shadowGenerator2;
   var skyboxMaterial;
   var skybox;
   var rlsSound;
   var meshesForAnimation;
   var activeState = "001";
var button1;
 var button;
  var panel;
  var baseLoad = 5000;
  var currentLoad = 5000;
 // var image;
  var globalObj = {
      errorMessage: "",
      image:null,
      rectangle:null
  };
  showConfigurableOptions = function(meshName){
    var controlName = "";
    switch(meshName){
        case "ChamferBo3":
        case "ChamferBo8":
        console.log("Show Crank Options");
        controlName = "Crank";
        break;
        case "Cylinder23":
        case "Cylinder24":
        console.log("Show Weight Options");
        controlName = "Weight";
        break;
        default:
        break;
    }
      for(var i=0; i< panel.children.length; i++){
          if(panel.children[i].name.indexOf(controlName)==-1){
              panel.children[i].isVisible = false;
          }
          else{
              panel.children[i].isVisible = true;
          }
      }
      panel.isVisible = true;
      beginOrStopAllAnimations(false);
      clearInterval(globalObj.intervalNumber);
      data.splice(0,data.length);
  }

  beginOrStopAllAnimations = function(beginAnimation, animationSpeed, loop){
    if(beginAnimation){
        //scene.beginAnimation(scene.getMeshByName("LowerRatingGroup001"),0,100,true);
        scene.beginAnimation(scene.getMeshByName("TopGroup"),0,100,loop,animationSpeed);
        scene.beginAnimation(scene.getMeshByName("MiddleGroup"),0,100,loop,animationSpeed);
        scene.beginAnimation(scene.getMeshByName("LowerRatingGroup001"),0,100,loop,animationSpeed);
        scene.beginAnimation(scene.getMeshByName("Rope001"),0,100,loop,animationSpeed);
        scene.beginAnimation(scene.getMeshByName("Rope002"),0,100,loop,animationSpeed);

    }
    else{
        scene.stopAllAnimations();
    }
  }

  handleWeightChange = function(weight){
    var controlWeights = ["Cylinder23", "Cylinder24", "Cylinder25", "Cylinder26"];
    var controlMesh = [];
    for(var i=0; i<controlWeights.length; i++){
        controlMesh.push(scene.getMeshByName(controlWeights[i]));
    }
    var scalingRatio = weight/baseLoad;
    scene.registerBeforeRender(function(){
        for(var i=0; i<controlMesh.length; i++){
            controlMesh[i].scaling.y = scalingRatio;
        }
    });
    if(weight>9000){
        globalObj.intervalNumber = setInterval(updateGraphForPeakMalfunctionLoad,20);
        beginOrStopAllAnimations(true, 1, false);
        // setTimeout(function(){
        //     beginOrStopAllAnimations(true, 1, false);
        // },100);
        setTimeout(function(){
            beginOrStopAllAnimations(true, 0.5, false);
        },200);
         setTimeout(function(){
            beginOrStopAllAnimations(true, 0.5, false);
        },400);

        setTimeout(function(){
            globalObj.image.isVisible = true;
            globalObj.errorMessage = "Drive Stopped Alert: Malfunction Peak Load State";
            clearInterval(globalObj.intervalNumber);
            
        },7000);
        // setTimeout(function(){
        //     beginOrStopAllAnimations(false);
        // },400)
        // setTimeout(function(){
        //     beginOrStopAllAnimations(true, 0.2, false);
        // },100);
        
        
    }
    else{
        beginOrStopAllAnimations(true, 1, true);
        globalObj.image.isVisible = false;
        globalObj.errorMessage = "";
        globalObj.rectangle.isVisible = false;
        globalObj.intervalNumber = setInterval(updateGraph,10);

    }
  }

createOptions = function(){
     var advancedTexture2 = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
     panel = new BABYLON.GUI.StackPanel();
    advancedTexture2.addControl(panel);
    var textblock = new BABYLON.GUI.TextBlock();
    textblock.name = "tblkWeightOptionHeader";
    textblock.height = "50px";
    panel.addControl(textblock);

    var slider = new BABYLON.GUI.Slider();
    slider.name = "sldrWeight";
    slider.minimum = 0;
    slider.maximum = 10000;
    slider.value = currentLoad;
    slider.height = "20px";
    slider.width = "200px";
    slider.borderColor = "green";
    slider.color= "greenyellow";
    slider.background = "yellow";
    slider.barOffset = "5px";
    slider.height = "20px";
    slider.width = "200px";
    slider.thumbWidth = "5px";
    slider.isThumbCircle = true;
    slider.isThumbClamped  = false;
    slider.onValueChangedObservable.add(function(value) {
        textblock.text = "Current Load: " + parseInt(value) + " lbs";
    });
    panel.addControl(slider);

    var btnUpdateWeight = BABYLON.GUI.Button.CreateSimpleButton("btnUpdateWeight", "Update Weight");
    btnUpdateWeight.width = "150px"
    btnUpdateWeight.height = "20px";
    btnUpdateWeight.color = "black";
    btnUpdateWeight.cornerRadius = 5;
    btnUpdateWeight.background = "greenyellow";
    btnUpdateWeight.onPointerUpObservable.add(function() {
        panel.isVisible = false;
        handleWeightChange(slider.value);
        //alert(slider.value);
        
    });
     panel.addControl(btnUpdateWeight);

    var textblock2 = new BABYLON.GUI.TextBlock();
    textblock2.name = "tblkCrankOptionHeader";
    textblock2.height = "50px";
    panel.addControl(textblock);

    var addRadio = function(text,name, parent) {
        var button = new BABYLON.GUI.RadioButton();
       
        button.width = "20px";
        button.height = "20px";
        button.color = "lime";
        button.background = "yellow";
        button.onIsCheckedChangedObservable.add(function(state) {
            if (state) {
                textblock2.text = "You selected " + text;
            }
        });
        var header = BABYLON.GUI.Control.AddHeader(button, text, "130px", { isHorizontal: true, controlFirst: true });
        header.height = "30px";        
        parent.addControl(header);  
        panel.children[panel.children.length-1].name = name;  
    }
    addRadio("Crank Hole 1","rbCrankOption1", panel);
    addRadio("Crank Hole 2","rbCrankOption2", panel);
    addRadio("Crank Hole 3","rbCrankOption3", panel);
    addRadio("Crank Hole 4","rbCrankOption4", panel);
    var btnUpdateCrank = BABYLON.GUI.Button.CreateSimpleButton("btnUpdateCrank", "Update Crank");
    btnUpdateCrank.width = "150px"
    btnUpdateCrank.height = "20px";
    btnUpdateCrank.color = "black";
    btnUpdateCrank.cornerRadius = 5;
    btnUpdateCrank.background = "greenyellow";
    btnUpdateCrank.onPointerUpObservable.add(function() {
        panel.isVisible = false;     
    });
     panel.addControl(btnUpdateCrank);
    panel.isVisible = false;
}
createGUIControls = function(){
    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");   
       createOptions();
    button1 = BABYLON.GUI.Button.CreateSimpleButton("btnShowSurfaceCard", "Surface Card");
    button1.width = "150px"
    button1.height = "20px";
    button1.color = "black";
    button1.cornerRadius = 5;
    button1.background = "greenyellow";
    button1.linkOffsetY = -200;
    button1.linkOffsetX = -100;
    button1.onPointerUpObservable.add(function() {
        //alert("you did it!");
        displayGraph("#graph1", data, 400, 150, "basis", false, 10, 10); //linear
        globalObj.intervalNumber = setInterval(updateGraph,10);
        beginOrStopAllAnimations(true,1,true);
    });
    var rectangle = new BABYLON.GUI.Rectangle("rect");
    globalObj.rectangle = rectangle;
    rectangle.background = "black";
    rectangle.color = "yellow";
    rectangle.width = "300px";
    rectangle.height = "50px";
    var text1 = new BABYLON.GUI.TextBlock("text1");
    text1.fontFamily = "Helvetica";
    text1.textWrapping = true;
    text1.text = "Hover in this long text to apply spacing. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.";
    text1.color = "white";
    text1.fontSize = "14px";
    rectangle.addControl(text1);
    rectangle.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
    rectangle.isVisible=false;
     var image = new BABYLON.GUI.Image("caution1", "textures/caution2.png");
     globalObj.image = image;
    image.width = "30px";
    image.height = "25px";
    image.cellId = 0;
    image.cellHeight = 30;
    image.cellWidth =30;
    image.isVisible = false;
    image.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
      image.onPointerUpObservable.add(function() {
        //alert("you did it!");
        globalObj.rectangle.children[0].text = globalObj.errorMessage;
        globalObj.rectangle.isVisible = true;
       // var toastHTML = '<span>I am toast content</span><button class="btn-flat toast-action">Undo</button>';
       // M.toast({html: toastHTML});

       
        // var options = {
        //     style: {
        //         main: {
        //             background: "pink",
        //             color: "black"
        //         }
        //     }
        // };

        // iqwerty.toast.Toast('Hello!', options);
        
    });
    // image.sourceWidth = 64;
     //   image.sourceHeight = 64;
     setInterval(() => {        
             if (image.cellId < 1) image.cellId++;
             else image.cellId = 0;
     }, 200);
    
    advancedTexture.addControl(image);
    advancedTexture.addControl(button1);
     advancedTexture.addControl(rectangle);
   // setTimeout(function(){
        button1.linkWithMesh(scene.getMeshByName("Group01"));
   // })        


  
    //Anchor Buttons

    //   var anchor = new BABYLON.AbstractMesh("anchor", scene);
    //    var manager = new BABYLON.GUI.GUI3DManager(scene);        
    //     // Let's add a button
    //     button = new BABYLON.GUI.HolographicButton("down");
    //     manager.addControl(button);
    //     button.linkToTransformNode(anchor);
    //     button.position.z = -1.5;

    //     button.text = "Show Surface Card";
    //     button.imageUrl = "./textures/down.png"; 
    //     button.onPointerUpObservable.add(function(){
    //            // donut.rotation.x -= 0.05;
    //         });
    //         button.position.y = 7.5;
    //         button.scaling  = {x:1,y:0.5, z:0.2};
    //         button.frontMaterial.albedoColor = {r:1, g:0, b:0};
}

 function vecToLocal(vector, mesh){
        var m = mesh.getWorldMatrix();
        var v = BABYLON.Vector3.TransformCoordinates(vector, m);
		return v;		 
    }

    function castRay(){       
        var camera = scene.activeCamera;
        var origin = camera.position;
	
	    var forward = new BABYLON.Vector3(0,0,1);		
	    forward = vecToLocal(forward, camera);
	
	    var direction = forward.subtract(origin);
	    direction = BABYLON.Vector3.Normalize(direction);
	
	    var length = 10000;
	
	    var ray = new BABYLON.Ray(origin, camera.getWorldMatrix(), length);
        BABYLON.RayHelper.CreateAndShow(ray, scene, new BABYLON.Color3(1, 1, 0.1));

        var hit = scene.pickWithRay(ray);

        if (hit.pickedMesh){
            //console.log(hit.pickedMesh.name);
		   //hit.pickedMesh.scaling.y += 0.01;
	    }
    }
 
   



        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
            scene.gravity = new BABYLON.Vector3(0, -9.81, 0);

            scene.onPointerMove = function () {
                mousemovef();
            };

             function mousemovef(){
                var pickResult = scene.pick(scene.pointerX, scene.pointerY);

                if (pickResult.hit) {
                    // var diffX = pickResult.pickedPoint.x - box.position.x;
                    // var diffY = pickResult.pickedPoint.z - box.position.z;
                    // box.rotation.y = Math.atan2(diffX,diffY);			          
                }	
            }
            //Adding a light
            var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(20, 20, 100), scene);
        //var VRHelper = scene.createDefaultVRExperience();
          
            //Adding an Arc Rotate Camera
            //var camera = new BABYLON.ArcRotateCamera("Camera", 10, -10.8, 5, BABYLON.Vector3.Zero(), scene);
            //camera = new BABYLON.WebVRFreeCamera("Camera",new BABYLON.Vector3(0,1,-3), scene);
             camera = new BABYLON.DeviceOrientationCamera ("DevOr_camera",new BABYLON.Vector3(-10,1,-10), scene);
           

           
           
            // Sets the sensitivity of the camera to movement and rotation
                // camera.angularSensibility = 10;
                // camera.moveSensibility = 10;
            camera.attachControl(canvas, true);
             camera.keysUp.push(87);
            camera.keysDown.push(83);
            camera.keysLeft.push(65);
            camera.keysRight.push(68);

            // var ground = BABYLON.Mesh.CreatePlane("ground", 20.0, scene);
            //     ground.material = new BABYLON.StandardMaterial("groundMat", scene);
            //     ground.material.diffuseColor = new BABYLON.Color3(1, 1, 1);
            //     ground.material.backFaceCulling = false;
            //     ground.position = new BABYLON.Vector3(0, 0, 0);
            //     ground.rotation = new BABYLON.Vector3(Math.PI / 2, 0, 0);
            //     ground.checkCollisions = true;

            //camera = new BABYLON.FollowCamera("followCam", BABYLON.Vector3.Zero(),scene);
           // camera.radius =5;
           // camera.heightOffset = 0;


            // Parameters : name, position, scene
           // var camera = new BABYLON.UniversalCamera("UniversalCamera", new BABYLON.Vector3(0, 0, -10), scene);

        // Targets the camera to a particular position. In this case the scene origin
            //camera.setTarget(BABYLON.Vector3.Zero());

        // Attach the camera to the canvas
           // camera.attachControl(canvas, true);
            camera.applyGravity = true;
            camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            // Enable Collisions
            scene.collisionsEnabled = true;
            camera.checkCollisions = true;
           var light = new BABYLON.PointLight("pointLight", new BABYLON.Vector3(0,2,0),scene);
            light.diffuse = new BABYLON.Color3(1,1,1);
            light.intensity = 1;
             var directionalLight = new BABYLON.DirectionalLight("DirectionalLight", new BABYLON.Vector3(-100,-100,100),scene);
           directionalLight.intensity = 3;

           var lightSphere2 = BABYLON.Mesh.CreateSphere("sphere", 10, 2, scene);
            lightSphere2.position = directionalLight.position;
            lightSphere2.material = new BABYLON.StandardMaterial("light", scene);
            lightSphere2.material.emissiveColor = new BABYLON.Color3(1, 1, 0);
            //var spotLight = new BABYLON.SpotLight("spotLight", new BABYLON.Vector3(0, 50, -10), new BABYLON.Vector3(0, -1, 0), Math.PI / 3, 0.2, scene);
            //spotLight.intensity = 3;
            var lightSphere = BABYLON.Mesh.CreateSphere("sphere", 10, 2, scene);
            //lightSphere.position = spotLight.position;
            lightSphere.material = new BABYLON.StandardMaterial("light", scene);
            lightSphere.material.emissiveColor = new BABYLON.Color3(1, 1, 0);

            shadowGenerator = new BABYLON.ShadowGenerator(1024, directionalLight);
           
            shadowGenerator.useExponentialShadowMap = true;
             shadowGenerator.usePercentageCloserFiltering = true;
            scene.actionManager = new BABYLON.ActionManager(scene);
            scene.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction({trigger: BABYLON.ActionManager.OnKeyUpTrigger, parameter: " "},
                function(){
                    console.log("Spaceeee");
                })
            
            )
            // The first parameter can be used to specify which mesh to import. Here we import all meshes
            BABYLON.SceneLoader.ImportMesh("", "scenes/", "OilRig012WIP.babylon", scene, function (newMeshes) {
                var pickableMeshNames= ["Cylinder25","Cylinder26","ChamferBo1","ChamferBo4","Cylinder24","Cylinder23","ChamferBo3","ChamferBo2","ChamferBo006","ChamferBo007","ChamferBo008","ChamferBo009","Cylinder028","Cylinder029","Cylinder030","Cylinder031","ChamferBo010","ChamferBo011","ChamferBo012","ChamferBo013","Cylinder032","Cylinder033","Cylinder034","Cylinder035","ChamferBo014","ChamferBo015","ChamferBo016","ChamferBo017","Cylinder036","Cylinder037","Cylinder038","Cylinder039"];
                meshesForAnimation = newMeshes;
                beginOrStopAllAnimations(false);
                 createGUIControls();
                var pickableMesh = [];
                for(var i=0; i < newMeshes.length; i++){
                    let mesh = newMeshes[i];
                    console.log(mesh.name);
                     if(pickableMeshNames.indexOf(mesh.name)!=-1){
                        //  if(mesh.name!=="LowerRatingGroup001"){
                        //     scene.registerBeforeRender(function(){
                        //            mesh.visibility=0;
                        //     })                         
                        //  }
                   // if(mesh.name.indexOf("Rope")!=-1 || mesh.name.indexOf("Cylinder23")!=-1){
                         mesh.isPickable = true; 	
                        mesh.actionManager = new BABYLON.ActionManager(scene);
                        
                        //ON MOUSE ENTER
                        mesh.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger, function(ev){	
                            //mesh.material.emissiveColor = BABYLON.Color3.Blue();
                            mesh.scalingDeterminant = 1.35;
                            //mesh.position.y+=10;
                        }));
                        
                        //ON MOUSE EXIT
                        mesh.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger, function(ev){
                            //mesh.material.emissiveColor = BABYLON.Color3.Black();
                             mesh.scalingDeterminant = 1;
                            // mesh.position.y-=10;
                        }));

                         //ON MOUSE EXIT
                        mesh.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickDownTrigger, function(ev){
                            //mesh.material.emissiveColor = BABYLON.Color3.Black();
                            console.log("DownClick ", mesh.name);
                            showConfigurableOptions(mesh.name);
                             //mesh.scalingDeterminant = 1;
                            // mesh.position.y-=10;
                        }));
                    }                   
                }
                engine.hideLoadingUI();
               // vrHelper.enableTeleportation({floorMeshName: "Plane001"});
                //vrHelper.enableInteractions()
                // Only show gaze dot on meshes with Flags in their name (eg. flags above user)
                // vrHelper.raySelectionPredicate = (mesh) => {
                //     if (mesh.name.indexOf("Plane001") !== -1) {
                //         return true;
                //     }
                //     return false;
                // };
                console.log(newMeshes);
                //camera.target = newMeshes[0];
                camera.target = scene.getMeshByName("Line02");
                var rlsPump = scene.getMeshByName("Group03");
                //rlsSound.attachToMesh(rlsPump);
                var material = new BABYLON.StandardMaterial("material1.scene",scene);
                material.diffuseColor = new BABYLON.Color3(1,0,1);
               // material.wireframe = true;
                for(var i=0; i < newMeshes.length; i++){
                   // newMeshes[i].material = material;
                   newMeshes.checkCollisions= true;
                }

                 shadowGenerator.addShadowCaster(rlsPump,true);           
                var ground = scene.getMeshByName("Plane001");
                var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
                groundMaterial.diffuseTexture = new BABYLON.Texture("textures/ground.jpg", scene);
                groundMaterial.diffuseTexture.uScale = 6;
                groundMaterial.diffuseTexture.vScale = 6;
                groundMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
                ground.material = groundMaterial;
                 ground.receiveShadows = true;
            });

            showOrHideChildMesh = function(parentMeshName,showMesh){
                var parentMesh = scene.getMeshByName(parentMeshName);
                if(parentMesh && parentMesh.visibility!=0){
                    parentMesh.visibility=0;
                    var childMeshArr = parentMesh.getChildren();
                    for(var childIndex=0; childIndex<childMeshArr.length; childIndex++){
                        childMeshArr[childIndex].visibility=showMesh;
                    }
                }
            }
        
            // Move the light with the camera
            scene.registerBeforeRender(function () {
                var states = ["001","002","003","004"];
                var middleGroupName = "MiddleRodRotatingGroup001";
                for(var stateIndex=0; stateIndex<states.length; stateIndex++){
                    var currentState = states[stateIndex];
                    if(currentState!=activeState){
                        showOrHideChildMesh("LowerRatingGroup"+currentState,0);
                    }
                }
                 showOrHideChildMesh("MiddleRodRotatingGroup001",0);
              // castRay();
            });
        
            return scene;
        }

        var createSky = function () {
            skybox = BABYLON.Mesh.CreateBox("skyBox", 100.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;
        };



var setSkyConfig = function (property, from, to) {
		var keys = [
            { frame: 0, value: from },
			{ frame: 100, value: to }
        ];
		
		var animation = new BABYLON.Animation("animation", property, 100, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
		animation.setKeys(keys);
		
		scene.stopAnimation(skybox);
		scene.beginDirectAnimation(skybox, [animation], 0, 100, false, 1);
	};
	
	window.addEventListener("keydown", function (evt) {
		switch (evt.keyCode) {
			case 49: setSkyConfig("material.inclination", skyboxMaterial.inclination, 0); break; // 1
			case 50: setSkyConfig("material.inclination", skyboxMaterial.inclination, -0.5); break; // 2

			case 51: setSkyConfig("material.luminance", skyboxMaterial.luminance, 0.1); break; // 3
			case 52: setSkyConfig("material.luminance", skyboxMaterial.luminance, 1.0); break; // 4
			
			case 53: setSkyConfig("material.turbidity", skyboxMaterial.turbidity, 40); break; // 5
			case 54: setSkyConfig("material.turbidity", skyboxMaterial.turbidity, 5); break; // 6
			
			default: break;
		}
    });
	
	


        var createGround = function () {
            var ground = BABYLON.Mesh.CreateGround("ground1", 12, 36, 2, scene);
            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("textures/ground.jpg", scene);
            groundMaterial.diffuseTexture.uScale = 6;
            groundMaterial.diffuseTexture.vScale = 6;
            groundMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            ground.material = groundMaterial;
        };

        var createSound = function(){
            rlsSound = new BABYLON.Sound("rls", "sounds/rls.mp3", scene, null, { loop: true, autoplay: true });
            rlsSound.setDirectionalCone(90, 180, 0.2);
            rlsSound.setLocalDirectionToMesh(new BABYLON.Vector3(1, 0, 0));
           // violons11.attachToMesh(box);
        }

         var createButtons = function(){
             // Create the 3D UI manager
                var manager = new BABYLON.GUI.GUI3DManager(scene);
                // Create a horizontal stack panel
                var panel = new BABYLON.GUI.StackPanel3D();
                panel.margin = 0.02;            
                manager.addControl(panel);
                panel.position.z = -1.5;
                // Let's add some buttons!
                var addButton = function(text) {
                    var button = new BABYLON.GUI.Button3D("orientation");
                    panel.addControl(button);
                    button.onPointerUpObservable.add(function(){
                        panel.isVertical = !panel.isVertical;
                    });   
                    
                    var text1 = new BABYLON.GUI.TextBlock();
                    text1.text = text;
                    text1.color = "white";
                    text1.fontSize = 24;
                    button.content = text1;  
                }
                addButton("Forward");
                addButton("Backward");

        }
        
        var scene = createScene();
       
         scene.onPointerDown = function (evt, pickResult) {
            // debugger;
             
            // if the click hits the ground object, we change the impact position
            if (pickResult.hit) {
                console.log("pickResult.hit");
                console.log(pickResult.pickedMesh.name);
                //debugger;
                //impact.position.x = pickResult.pickedPoint.x;
               // impact.position.y = pickResult.pickedPoint.y;
            }
        };
        //var vrHelper = scene.createDefaultVRExperience({createDeviceOrientationCamera:true});
       // createSound();
        createSky();
        //createButtons();
       
        // Set to Day
	//setSkyConfig("material.inclination", skyboxMaterial.inclination, 0);
        //createGround();
        var x= 50;
        engine.runRenderLoop(function () {
            if (scene) {
                 var light = scene.getLightByName("pointLight");
                 light.position = camera.position;
                     var directionalLight = scene.getLightByName("DirectionalLight");
                scene.render();
            }
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });

    </script>

    <script>
        
	function displayGraph(id, data, width, height, interpolation, animate, updateDelay, transitionDelay) {

  var margin = {
      top: 30,
      right: 20,
      bottom: 30,
      left: 70
    },
    width = width - margin.left - margin.right,
    height = height - margin.top - margin.bottom;

var svg = d3.select(id)
  .append("svg:svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
var graph = svg.append('g')
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  var x = d3.scale.linear().domain([0, 120]).range([0, width]); // max(x) is 100
  var y = d3.scale.linear().domain([0, 25000]).range([height, 0]); // max(y) is 1   

	  var line = d3.svg.line()
    .x(function(d, i) {
      return x(d[0]);
    })
    .y(function(d) {
      return y(d[1]);
    })
    .interpolate(interpolation)
	
	  var line2 = d3.svg.line()
    .x(function(d, i) {
      return x(d[0]);
    })
    .y(function(d) {
      return y(d[1]);
    })
    .interpolate(interpolation)

  var xAxis = d3.svg.axis().scale(x)
    .orient("bottom").ticks(10);
  var yAxis = d3.svg.axis().scale(y)
    .orient("left").ticks(6);

	//Surface Card
  graph.append("svg:path")
    .attr("d", line(data))
    .attr('stroke', function(d) {
      return "darkgreen"
    });
	
	//Existing Permissible Load Up
	graph.append("svg:path")
    .attr("d", line2(newData))
    .attr('stroke', function(d) {
      return "rgb(188,153,199)"
    });
	
	//Existing Permissible Load Down
	graph.append("svg:path")
    .attr("d", line2(newData))
    .attr('stroke', function(d) {
      return "rgb(188,153,199)"
    });
	
	//InBalance Permissible Load Up
	graph.append("svg:path")
    .attr("d", line2(newData))
    .attr('stroke', function(d) {
      return "rgb(237,221,70)"
    });
	
	//In Balance Permissible Load Down
	graph.append("svg:path")
    .attr("d", line2(newData))
    .attr('stroke', function(d) {
      return "rgb(237,221,70)"
    });
	
	
  graph.append("g") // Add the X Axis
    .attr('stroke', function(d) {
      return "darkolivegreen"
    })
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);
  graph.append("g") // Add the Y Axis
    .attr('stroke', function(d) {
      return "darkolivegreen"
    })
    .attr("class", "y axis")
    .call(yAxis);
	
	  graph.append("line")
        .attr(
        {
            "class":"horizontalGrid",
            "x1" : 0,
            "x2" : width,
            "y1" : y(23000),
            "y2" : y(23000),
            "fill" : "none",
            "shape-rendering" : "crispEdges",
            "stroke" : "black",
            "stroke-width" : "1px",
            "stroke-dasharray": ("3, 3")
        });


  function redrawWithAnimation() {
    //x.domain(d3.extent(data, function(d,i) { return i; }));
    /*x.domain([0, 100]); // max(x) is 100
    y.domain([0, d3.max(data, function(d) {
      return d.lr;
    })]);*/
	 x.domain([0,d3.max(data, function(d) {
      return d[0];
    })]);
    y.domain([0, d3.max(data, function(d) {
      return d[1];
    })]);
    graph.selectAll("path")
      .data([data])
      .attr("transform", "translate(" + x(1) + ")")
      .attr("d", line)
      .transition()
      .ease("linear")
      .duration(transitionDelay)
      .attr("transform", "translate(" + x(0) + ")");

  }

  function redrawWithoutAnimation() {
    // static update without animation
	var path = graph.selectAll("path");
    d3.select(path[0][0])
      .data([data]) // set the new data
      .attr("d", line); // apply the new data values
	  
	   //d3.select(path[0][1])
      //.data([newData]) // set the new data
      //.attr("d", line); // apply the new data values
	  
	  d3.select(path[0][1])
      .data([permissibleLoadNewData.PermissibleLoadInBalanceUpStrokeValue]) // set the new data
      .attr("d", line); // apply the new data values
	  
	  d3.select(path[0][2])
      .data([permissibleLoadNewData.PermissibleLoadInBalanceDownStrokeValue]) // set the new data
      .attr("d", line); // apply the new data values
	  
	  d3.select(path[0][3])
      .data([permissibleLoadNewData.PermissibleLoadExistingUpStrokeValue]) // set the new data
      .attr("d", line); // apply the new data values
	  
	  d3.select(path[0][4])
      .data([permissibleLoadNewData.PermissibleLoadExistingDownStrokeValue]) // set the new data
      .attr("d", line); // apply the new data values
	  
  }
  setInterval(function() {
    if (animate) {
      redrawWithAnimation();
    } else {
      redrawWithoutAnimation();
    }
  }, updateDelay);
} //displayGraph
var data = [];
var newData = [];
var permissibleLoadNewData = {
	"PermissibleLoadInBalanceUpStrokeValue":[],
	"PermissibleLoadInBalanceDownStrokeValue":[],
	"PermissibleLoadExistingUpStrokeValue":[],
	"PermissibleLoadExistingDownStrokeValue":[],
};

var index=0;
var multiplicationFactor=1;
var surfaceCardData = [[0.08,15354.0],[0.16,15300.0],[0.32,15196.0],[0.48,14956.0],[0.64,14564.0],[1.07,14257.0],[1.54,14296.0],[2.01,14432.0],[2.48,14553.0],[3.17,14574.0],[3.94,14843.0],[4.69,15229.0],[5.46,15669.0],[6.38,16096.0],[7.41,16332.0],[8.43,16603.0],[9.46,16873.0],[10.59,17139.0],[11.85,17466.0],[13.11,17730.0],[14.36,17994.0],[15.68,18195.0],[17.12,18134.0],[18.59,18085.0],[20.04,18077.0],[21.54,18070.0],[23.17,18003.0],[24.8,17949.0],[26.43,17988.0],[28.06,18048.0],[29.82,18085.0],[31.59,18270.0],[33.34,18612.0],[35.12,19096.0],[36.96,19686.0],[38.82,20241.0],[40.68,20716.0],[42.53,21216.0],[44.42,21752.0],[46.33,22287.0],[48.24,22559.0],[50.15,22821.0],[52.07,23059.0],[54.01,23144.0],[55.94,23091.0],[57.87,22905.0],[59.81,22650.0],[61.75,22473.0],[63.7,22366.0],[65.65,22239.0],[67.6,22102.0],[69.51,21994.0],[71.44,21783.0],[73.37,21554.0],[75.3,21368.0],[77.19,21291.0],[79.05,21072.0],[80.92,20752.0],[82.8,20326.0],[84.62,19808.0],[86.4,19364.0],[88.19,18906.0],[89.98,18406.0],[91.72,17872.0],[93.39,17372.0],[95.06,17005.0],[96.73,16605.0],[98.37,16177.0],[99.9,15771.0],[101.43,15623.0],[102.96,15679.0],[104.49,15832.0],[105.79,16001.0],[107.14,16091.0],[108.49,16225.0],[109.81,16308.0],[110.96,16378.0],[112.11,16484.0],[113.26,16657.0],[114.41,16794.0],[115.33,16837.0],[116.27,16828.0],[117.2,16900.0],[118.14,17101.0],[118.86,17349.0],[119.58,17582.0],[120.3,17773.0],[121.01,18037.0],[121.53,18401.0],[122.02,18711.0],[122.52,18944.0],[123.01,19142.0],[123.33,19420.0],[123.6,19635.0],[123.88,19779.0],[124.15,19837.0],[124.27,19716.0],[124.33,19571.0],[124.39,19423.0],[124.45,19277.0],[124.38,19129.0],[124.23,18929.0],[124.09,18726.0],[123.94,18551.0],[123.69,18423.0],[123.34,18306.0],[122.99,18231.0],[122.64,18174.0],[122.22,18116.0],[121.68,18029.0],[121.15,17875.0],[120.61,17762.0],[120.07,17647.0],[119.3,17478.0],[118.58,17215.0],[117.87,16973.0],[117.13,16766.0],[116.24,16592.0],[115.35,16415.0],[114.46,16214.0],[113.57,16100.0],[112.52,16066.0],[111.48,16066.0],[110.43,16199.0],[109.38,16317.0],[108.2,16397.0],[106.99,16427.0],[105.78,16506.0],[104.57,16598.0],[103.27,16692.0],[101.91,16789.0],[100.56,16908.0],[99.2,16995.0],[97.77,17067.0],[96.27,17155.0],[94.77,17338.0],[93.27,17485.0],[91.73,17578.0],[90.1,17648.0],[88.46,17751.0],[86.83,17958.0],[85.17,18184.0],[83.42,18386.0],[81.66,18536.0],[79.9,18672.0],[78.14,16786.0],[76.26,14043.0],[74.41,11244.0],[72.57,9521.0],[70.76,9697.0],[68.89,10287.0],[67.01,10863.0],[65.14,10894.0],[63.25,10736.0],[61.33,10508.0],[59.39,10375.0],[57.46,10706.0],[55.53,11014.0],[53.58,11224.0],[51.61,11299.0],[49.64,11179.0],[47.67,11073.0],[45.71,10923.0],[43.78,10728.0],[41.85,10493.0],[39.91,10347.0],[37.97,10351.0],[36.09,10449.0],[34.23,10561.0],[32.37,9945.0],[30.49,9726.0],[28.72,10017.0],[26.98,10854.0],[25.23,11729.0],[23.48,13108.0],[21.82,14142.0],[20.21,14485.0],[18.62,14476.0],[17.02,14589.0],[15.52,14886.0],[14.14,15278.0],[12.76,15615.0],[11.38,15562.0],[10.1,15453.0],[9.0,15365.0],[7.89,15344.0],[6.78,15400.0],[5.76,15666.0],[4.94,15854.0],[4.14,15954.0],[3.33,16028.0],[2.58,16121.0],[2.08,16185.0],[1.6,16226.0],[1.11,16334.0],[0.62,16890.0],[0.49,16984.0],[0.32,17039.0],[0.16,17012.0],[0.08,15354.0]];

var permissibleLoadData = {"InBalanceMaxTorque":434.86,"ExistingCounterbalance":780.49,"ExistingMaxTorque":784.15,"InbalanceEffectiveCBal":17372.46,"InBalanceReducerRating":67.95,"InBalanceCounterbalance":1142.1,"ReducerRating":640000.0,"ExistingReducerRating":122.52,"ExistingEffectiveCBal":11397.12,"Permissible-Load":[{"PermissibleLoadInBalanceUpStrokeValue":[[18.274594880430268,28010.406910338726],[22.503946633791664,27286.09681372235],[27.037493923003012,26797.40218342186],[31.833457830977945,26484.270989848043],[36.849777300949505,26307.268904518598],[42.04427563532251,26240.232924931606],[47.374773068970526,26266.079548274287],[52.79916623772245,26374.335837013503],[58.27549520044825,26559.671333156137],[63.762018181271095,26821.05154354844],[69.21731327855093,27161.31221251673],[74.60042477245452,27587.05596811797],[79.87106895670223,28108.841496790737],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0]],"PermissibleLoadExistingUpStrokeValue":[[10.89264289011839,25810.43645376476],[14.390694449159941,24169.55283417451],[18.274594880430268,23018.64851012385],[22.503946633791664,22201.445133159425],[27.037493923003012,21623.064470911046],[31.833457830977945,21223.088242999147],[36.849777300949505,20961.839687450574],[42.04427563532251,20812.922387450017],[47.374773068970526,20758.958992810163],[52.79916623772245,20789.078336021805],[58.27549520044825,20897.419025723855],[63.762018181271095,21082.265139952608],[69.21731327855093,21345.610492674237],[74.60042477245452,21693.051398419546],[79.87106895670223,22133.976676104718],[84.9899101715932,22682.08179664533],[89.91891154286658,23356.299695814043],[94.62175669468151,24182.334535330836],[99.06432870645328,25195.139727822156],[103.21522173186554,26442.961565967616],[107.04625055574209,27994.1103962593],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0]],"PermissibleLoadInBalanceDownStrokeValue":[[111.42205833589603,1315.0944847923747],[108.35676918596852,3054.0176604523085],[105.00248461534198,4363.82539089914],[101.36848555707668,5340.1147926920985],[97.46475947575136,6049.717060535336],[93.30245696650465,6541.518583414898],[88.89441444592498,6852.711523777927],[84.25573302269649,7012.508516409242],[79.40439813149099,7044.376522665412],[74.3619169434543,6967.364480257536],[69.15394114122593,6796.848814676034],[63.810832034363685,6544.881390558295],[58.368114464208595,6220.239868725888],[52.86675745866604,5828.221591617767],[47.35321570500041,5370.171376092145],[41.87916945291219,4842.676416697776],[36.50091394248566,4236.279941541168],[31.27837416175261,3533.42884728473],[26.273755828878762,2705.117866173785],[21.549885351390305,1705.1872600582042],[17.16833383465399,460.14286213721834],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0]],"PermissibleLoadExistingDownStrokeValue":[[88.89441444592498,301.1922436456575],[84.25573302269649,593.2055791763496],[79.40439813149099,767.3378922023053],[74.3619169434543,839.3826988126575],[69.15394114122593,821.5094333081606],[63.810832034363685,722.6603179457952],[58.368114464208595,548.649233007684],[52.86675745866604,301.9991387066291],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0],[0.0,0.0]]}],"pumpingunit":"{\"ID\":0,\"structureRating\":36500.0,\"recordID\":null,\"id\":0,\"RecordID\":null,\"unitid\":\"LC640-365-168\",\"unitDescription\":\"LUFKIN C640-365-168 WITH 94110B CRANKS\",\"unit_type\":\"1\",\"manufacturer\":\"LUFKIN CONVENTIONAL\",\"cbalphaseangle_or_distsprocketcenters\":0.0,\"num_crank_holes\":4,\"cbaltorque\":465000.0,\"M\":0.0,\"S\":0.0,\"K\":192.88,\"c_or_drum_diameter\":120.26,\"a_or_chain_weight\":210.0,\"p_or_drum_inertia\":148.5,\"i_or_weightbox_weight\":120.0,\"dimr1_or_trans_mech_weight\":47.0,\"dimr2_or_belting_stretch\":41.0,\"dimr3_or_belt_weight\":35.0,\"dimr4_or_sprocket_radius\":29.0,\"dimr5_or_sprocket_inertia\":0.0,\"reducer_speed_ratio\":28.6,\"crank_inertia\":242768.0,\"slow_gear_inertia\":3902.0,\"total_reducer_inertia\":168345.0,\"articulating_inertia\":951889.0,\"dbtype\":1,\"structure_unbalance\":-1500.0,\"reducer_rating\":640.0,\"structure_rating\":36500.0,\"official\":1,\"maximum_stroke\":168.0,\"crankid\":\"94110B CRANKS\",\"B\":0.0,\"lcb\":0.0,\"D\":0.0,\"E\":0.0,\"max_beam_weights\":0.0,\"is_estimated_inertia\":0,\"crank_rotation\":\"anti-clockwise\",\"selectedCrankHole\":3,\"tapercount\":3}"};

// display

updateGraph = function(){
 // var v = dataIn.shift();
 var newIndex = index%surfaceCardData.length;
 var pIndex = index%permissibleLoadData["Permissible-Load"][0].PermissibleLoadInBalanceUpStrokeValue.length;
 
 if(newIndex==0){
	multiplicationFactor = multiplicationFactor+0.01;
 }
 var v = surfaceCardData[newIndex];
// permissibleLoadNewData.PermissibleLoadInBalanceUpStrokeValue.push(permissibleLoadData["Permissible-Load"][0].PermissibleLoadInBalanceUpStrokeValue[newIndex]);
// permissibleLoadNewData.PermissibleLoadInBalanceDownStrokeValue.push(permissibleLoadData["Permissible-Load"][0].PermissibleLoadInBalanceDownStrokeValue[newIndex]);
// permissibleLoadNewData.PermissibleLoadExistingUpStrokeValue.push([permissibleLoadData["Permissible-Load"][0].PermissibleLoadInBalanceUpStrokeValue[pIndex][0]*0.9,permissibleLoadData["Permissible-Load"][0].PermissibleLoadInBalanceUpStrokeValue[pIndex][1]*0.8]);
// permissibleLoadNewData.PermissibleLoadExistingDownStrokeValue.push(permissibleLoadData["Permissible-Load"][0].PermissibleLoadExistingDownStrokeValue[newIndex]);
 //var v = surfaceCardData.shift();
 if(data.length%(5*surfaceCardData.length)==0){
     data.splice(0,data.length);
     multiplicationFactor = 1;
 }
  if (v) {
	//data.push(v);
	data.push([v[0]*multiplicationFactor,v[1]*multiplicationFactor]);
  }
  index++;
}

updateGraphForPeakMalfunctionLoad = function(){
 // var v = dataIn.shift();
 var newIndex = index%surfaceCardData.length;
 
 var v = surfaceCardData[newIndex];

  if (v) {
	//data.push(v);
	data.push([v[0],v[1]*1.2]);
  }
  index++;
}

    </script>
</body>
</html>